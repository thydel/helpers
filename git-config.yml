#!/usr/bin/env ansible-playbook
---

- name: &check Check ansible version
  hosts: all
  gather_facts: False
  tags: check-version
  vars: { min_ansible_version: 2.3.0 }
  tasks:
    - fail:
        msg: min ansible version is {{ min_ansible_version }}, ansible version is {{ ansible_version.string }}
      when: ansible_version.string | version_compare(min_ansible_version, 'lt')
      check_mode: False
      run_once: True
      delegate_to: localhost
      tags: always
      name: *check

- hosts: localhost
  tags: show
  tasks:
    - git_config:
        scope: local
        repo: '{{ repo | default(".") }}'
        name: '{{ name | default("user.email") }}'
      register: git_config
    - debug: { var: git_config.config_value }

- hosts: localhost
  tags: log
  tasks:
    - git_config:
        scope: local
        repo: '{{ repo | default(".") }}'
        name: '{{ item.key }}'
        value: '{{ item.value }}'
      with_dict:
        log.date: relative
        format.pretty: >-
          tformat:%C(auto,yellow)%h%C(auto,magenta)% G?
          %C(auto,blue)%>(12,trunc)%ad
          %C(auto,green)%<(8,trunc)%aN%C(auto,reset)%s%C(auto,red)% %d
          %C(auto,reset)

- hosts: localhost
  tags: mailmap
  tasks:
    - lineinfile:
        path: '{{ repo | default(playbook_dir) }}/.mailmap'
        line: '{{ item }}'
        create: True
      with_items:
        - thyepi <t.delamare@epiconcept.fr> Thierry Delamare
        - thydel <t.delamare@laposte.net>   Thierry Delamare
        - evens  <e.solignac@epiconcept.fr> Evens Solignac
        - cedric <c.girard@epiconcept.fr>   CÃ©dric Girard
    - lineinfile:
        path: '{{ repo | default(playbook_dir) }}/.gitignore'
        line: '{{ item }}'
        insertafter: '^\*~$'
      with_items: [ .mailmap, .stone ]
